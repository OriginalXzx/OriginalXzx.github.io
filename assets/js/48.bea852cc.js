(window.webpackJsonp=window.webpackJsonp||[]).push([[48],{451:function(t,a,s){"use strict";s.r(a);var r=s(1),e=Object(r.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("div",{staticClass:"custom-block tip"},[s("p",[t._v("full gc 在java程序开发中属于常见的异常情况，本文章通过记录一次full gc的排查过程，给读者一些full gc方面的排坑经验。")])]),t._v(" "),s("h2",{attrs:{id:"一、背景"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#一、背景"}},[t._v("#")]),t._v(" 一、背景")]),t._v(" "),s("p",[t._v("不知什么时候起线上某应用机器线上开始频繁full gc报警，鉴于平时忙碌的工作，加上报警并没有引起客诉，所以这成了一件懒得去理的事情，终于有一天我实在忍受不了了，必须一探究竟，彻底要解决这个问题。\n"),s("img",{attrs:{src:"http://p0.meituan.net/scarlett/5b9b52d31864a0663f5ad0fa3874603c139170.jpg",width:"70%",height:"auto"}})]),t._v(" "),s("h2",{attrs:{id:"二、处理过程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#二、处理过程"}},[t._v("#")]),t._v(" 二、处理过程")]),t._v(" "),s("h3",{attrs:{id:"_2-1-dump线上内存到本地"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-dump线上内存到本地"}},[t._v("#")]),t._v(" 2.1 dump线上内存到本地")]),t._v(" "),s("ul",[s("li",[t._v("申请线上机器sudo权限 "),s("br"),t._v("\n公司里面线上机器一般员工是没有sudo权限的，所以第一步需要申请权限")]),t._v(" "),s("li",[t._v("找到线上机器java进程Id linux直接使用 "),s("strong",[t._v("top")]),t._v(" 指令\n"),s("img",{attrs:{src:"http://p0.meituan.net/scarlett/3a34700f11e760db80ed2a4a36f35227183547.jpg",width:"70%",height:"auto"}})]),t._v(" "),s("li",[t._v("dump进程内存 "),s("br"),t._v("\n使用指令 "),s("strong",[t._v("sudo jmap -f -dump:live,format=b,file=dump_live.hprof 54600")]),t._v(" ,文件的格式自己定义，因为后面要用到JProfiler，所以选择hprof格式。")]),t._v(" "),s("li",[t._v("将线上机器上的文件拉到本地 "),s("br"),t._v("\n先登录到线上机器，使用指令 "),s("strong",[t._v("sftp xiaoming@jumper.sankuai.com")]),t._v("，线上机器登录到sftp，接着将需要传输的文件上传到sftp "),s("strong",[t._v("sftp> put ~/dump.hprof")]),t._v("。"),s("br"),t._v("本地登录到sftp，指令"),s("strong",[t._v("sftp xiaoming@jumper.sankuai.com")]),t._v("，将文件从sftp拉到本地，"),s("strong",[t._v("sftp> get ~/dump.hprof")]),t._v("。"),s("br"),t._v(" "),s("a",{attrs:{href:"https://10.linuxstory.net/how-to-use-sftp-to-securely-transfer-files-with-a-remote-server/"}},[s("em",[t._v("什么是sftp")])])])]),t._v(" "),s("h3",{attrs:{id:"_2-2-jprofiler分析内存文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-jprofiler分析内存文件"}},[t._v("#")]),t._v(" 2.2 JProfiler分析内存文件")]),t._v(" "),s("p",[t._v("直接使用JProfiler打开dump.hprof。 "),s("a",{attrs:{href:"http://resources.ej-technologies.com/jprofiler/help/doc"}},[s("em",[t._v("JProfiler使用说明")])]),s("br")]),t._v(" "),s("img",{attrs:{src:"http://p0.meituan.net/scarlett/49fc580ac42c674239eec446d6212ab2359643.jpg",width:"70%",height:"auto"}}),t._v("\n发现堆并没有特别大，利用jprofiler的特性可以发现贡献内存的对象主要来源于OriginServiceCache,怀疑跟这个有关。\n"),s("img",{attrs:{src:"http://p0.meituan.net/scarlett/c8e860c1b51409d0f8b9603fea88d0e4112034.jpg",width:"70%",height:"auto"}}),t._v(" "),s("h3",{attrs:{id:"_2-3-gc日志分析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-gc日志分析"}},[t._v("#")]),t._v(" 2.3 GC日志分析")]),t._v(" "),s("p",[t._v("频繁发生cms gc（old gc），有如下可能：")]),t._v(" "),s("p",[t._v("1.大对象至今晋升到老年代")]),t._v(" "),s("p",[t._v("2.有大量长时间存活的对象")]),t._v(" "),s("p",[t._v("3.老年代没到阈值，但永久代到了阈值，导致触发old gc"),s("br"),t._v("\n通过上一步分析下来，排除大对象的可能性，这个时候就需要看gc日志来定位问题了\n"),s("img",{attrs:{src:"http://p0.meituan.net/scarlett/1d0d52603036cf3dff5b485f1052eee492117.png",width:"70%",height:"auto"}}),t._v(" "),s("br"),t._v("\n可以看出，发生cms gc的时候，老年代占用了800M（共1.6G），也算到了该回收老年代的时候。"),s("br"),t._v("\n进一步地，看下老年代内存的统计："),s("br"),t._v(" "),s("img",{attrs:{src:"http://p0.meituan.net/scarlett/32818e2d2cab20b2a83e3d338be71827108421.jpg",width:"70%",height:"auto"}}),t._v(" "),s("br"),t._v("\n再看一下jvm启动参数：")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Xms5114m")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Xmx5114m")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Xss512k")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("XX"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("PermSize")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("384")]),t._v("m "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("XX"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MaxPermSize")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("384")]),t._v("m "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("XX"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("NewSize")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3540")]),t._v("m "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("XX"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MaxNewSize")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3540")]),t._v("m "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("XX"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SurvivorRatio")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("XX"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MaxTenuringThreshold")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("9")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("XX"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("UseConcMarkSweepGC")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("XX"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("DisableExplicitGC")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("XX"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ScavengeBeforeFullGC")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("XX"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("UseCMSCompactAtFullCollection")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("XX"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CMSParallelRemarkEnabled")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("XX"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CMSFullGCsBeforeCompaction")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("9")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("XX"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CMSInitiatingOccupancyFraction")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("XX"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CMSClassUnloadingEnabled")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("XX"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SoftRefLRUPolicyMSPerMB")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("XX"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ReduceInitialCardMarks")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("XX"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CMSPermGenSweepingEnabled")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("XX"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CMSInitiatingPermOccupancyFraction")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("XX"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ExplicitGCInvokesConcurrent")]),t._v(" \n")])])]),s("p",[t._v("其中：")]),t._v(" "),s("p",[t._v("a）首先jvm根据-XX:CMSInitiatingOccupancyFraction，-XX:+UseCMSInitiatingOccupancyOnly")]),t._v(" "),s("p",[t._v("来决定什么时间开始垃圾收集")]),t._v(" "),s("p",[t._v("b）如果设置了-XX:+UseCMSInitiatingOccupancyOnly，那么只有当old代占用确实达到了")]),t._v(" "),s("p",[t._v("-XX:CMSInitiatingOccupancyFraction参数所设定的比例时才会触发cms gc")]),t._v(" "),s("p",[t._v("c）如果没有设置-XX:+UseCMSInitiatingOccupancyOnly，那么系统会根据统计数据自行决定什么时候")]),t._v(" "),s("p",[t._v("触发cms gc；因此有时会遇到设置了80%比例才cms gc，但是50%时就已经触发了，就是因为这个参数")]),t._v(" "),s("p",[t._v("没有设置的原因")]),t._v(" "),s("p",[t._v("d) 在我们的配置中，没有UseCMSInitiatingOccupancyOnly，所以老年代不一定要到80%才会gc，和我们从统计图表上看到的情况是一样的。")]),t._v(" "),s("p",[t._v("所以我们可以得出结论：发生cms gc确实是因为老年代增长过快导致的。")]),t._v(" "),s("p",[t._v("那是什么原因导致老年代增长过快呢？")]),t._v(" "),s("p",[t._v("有以下几种可能：")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("To Survivor区不够时，对象进入老年代")])]),t._v(" "),s("li",[s("p",[t._v("大对象（超过 PretenureSizeThreshold 设置的值）直接进入老年代（PretenureSizeThreshold=0，无论多大对象，优先分配Eden区） ---- 不需修改")])]),t._v(" "),s("li",[s("p",[t._v("年龄达到MaxTenuringThreshold 的对象 （-XX:MaxTenuringThreshold=6）")])]),t._v(" "),s("li",[s("p",[t._v("如果在Survivor区中相同年龄（设年龄为age）的对象的所有大小之和超过Survivor空间的一半，年龄大于或等于该年龄（age）的对象就可以直接进入老年代，无需等到MaxTenuringThreshold中要求的年龄。")])])]),t._v(" "),s("p",[t._v("于是，我们要看下年轻代的情况：")]),t._v(" "),s("img",{attrs:{src:"http://p0.meituan.net/scarlett/e90cdd937f8e8f4635598cb8cb2ee732166638.jpg",width:"70%",height:"auto"}}),t._v(" "),s("p",[t._v("Survivor竟然常年居于100%，怪不得直接进老年代了。")]),t._v(" "),s("p",[t._v("这时候，我们发现gc日志上的信息还不是很全，需要再加几个参数：")]),t._v(" "),s("p",[t._v("-XX:+PrintGCDateStamps")]),t._v(" "),s("p",[t._v("-XX:+PrintTenuringDistribution")]),t._v(" "),s("p",[t._v("这样，我们终于看到了详细的young GC日志：")]),t._v(" "),s("img",{attrs:{src:"http://p1.meituan.net/scarlett/eee9b23d5bf94c163e46108a620f20b4300711.jpg",width:"70%",height:"auto"}}),t._v(" "),s("p",[t._v("其中，Desired survivor size为185M，这个值是通过survivor设置的大小（3540M（新生代大小）×10%（SurvivorRatio=8）×0.5（TargetSurvivorRatio，取默认值50））计算出来的。")]),t._v(" "),s("p",[t._v("而我们实际surviving bytes为257M，大于了Desired survivor size，导致了premature promotion。此时从 Eden 存活下来的和原来在 Survivor 空间中不够老的对象占满 Survivor 后， 就会提升到老年代。")]),t._v(" "),s("p",[t._v("要解决这个问题，我们一是要增加内存，二是将SurvivorRatio设为6，TargetSurvivorRatio设为75，增大survivor大小。")])])}),[],!1,null,null,null);a.default=e.exports}}]);