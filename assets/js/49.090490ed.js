(window.webpackJsonp=window.webpackJsonp||[]).push([[49],{453:function(e,t,a){"use strict";a.r(t);var n=a(1),i=Object(n.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("div",{staticClass:"custom-block tip"},[a("p",[e._v("æœ¬äººä»ä¸šä»¥æ¥ç¬¬ä¸€æ¬¡ç¢°åˆ°æ•°æ®åº“æ­»é”é—®é¢˜ï¼Œå½“ç„¶æ˜¯æ·±ç©¶åˆ°åº•,ä¸å¯å¿½ç•¥äº†ã€‚")])]),e._v(" "),a("h2",{attrs:{id:"æ­»é”æ‚„ç„¶è€Œè‡³"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#æ­»é”æ‚„ç„¶è€Œè‡³"}},[e._v("#")]),e._v(" æ­»é”æ‚„ç„¶è€Œè‡³")]),e._v(" "),a("p",[e._v("ä¸€å¤©ä¸‹åˆå‘ç°æœåŠ¡æŠ¥é”™ï¼ŒæŠ¥é”™ä¿¡æ¯å¦‚ä¸‹")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("com.mysql.jdbc.exceptions.jdbc4.MySQLTransactionRollbackException: Deadlock found when trying to get lock; try restarting transaction\nat sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)\nat sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)\nat sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)\nat java.lang.reflect.Constructor.newInstance(Constructor.java:422)\nat com.mysql.jdbc.Util.handleNewInstance(Util.java:404)\nat com.mysql.jdbc.Util.getInstance(Util.java:387)\nat com.mysql.jdbc.SQLError.createSQLException(SQLError.java:950)\nat com.mysql.jdbc.MysqlIO.checkErrorPacket(MysqlIO.java:3966)\nat com.mysql.jdbc.MysqlIO.checkErrorPacket(MysqlIO.java:3902)\nat com.mysql.jdbc.MysqlIO.sendCommand(MysqlIO.java:2526)\nat com.mysql.jdbc.MysqlIO.sqlQueryDirect(MysqlIO.java:2673)\nat com.mysql.jdbc.ConnectionImpl.execSQL(ConnectionImpl.java:2549)\nat com.mysql.jdbc.PreparedStatement.executeInternal(PreparedStatement.java:1861)\nat com.mysql.jdbc.PreparedStatement.executeUpdateInternal(PreparedStatement.java:2073)\nat com.mysql.jdbc.PreparedStatement.executeUpdateInternal(PreparedStatement.java:2009)\nat com.mysql.jdbc.PreparedStatement.executeLargeUpdate(PreparedStatement.java:5098)\nat com.mysql.jdbc.PreparedStatement.executeUpdate(PreparedStatement.java:1994)\nat com.alibaba.druid.pool.DruidPooledPreparedStatement.executeUpdate(DruidPooledPreparedStatement.java:253)\nat com.dianping.zebra.single.jdbc.SinglePreparedStatement$2.doAction(SinglePreparedStatement.java:92)\nat com.dianping.zebra.single.jdbc.SinglePreparedStatement$2.doAction(SinglePreparedStatement.java:80)\nat com.dianping.zebra.single.jdbc.SingleStatement.executeWithFilterOrigin(SingleStatement.java:228)\nat com.dianping.zebra.single.jdbc.SingleStatement.access$000(SingleStatement.java:37)\nat com.dianping.zebra.single.jdbc.SingleStatement$8.executeSingleStatement(SingleStatement.java:215)\nat com.dianping.zebra.filter.DefaultJdbcFilter.executeSingleStatement(DefaultJdbcFilter.java:60)\nat com.dianping.zebra.single.jdbc.SingleStatement$8.executeSingleStatement(SingleStatement.java:212)\nat com.dianping.zebra.filter.DefaultJdbcFilter.executeSingleStatement(DefaultJdbcFilter.java:60)\nat com.dianping.zebra.single.jdbc.SingleStatement$8.executeSingleStatement(SingleStatement.java:212)\nat com.dianping.zebra.filter.audit.AuditFilter.executeSingleStatement(AuditFilter.java:67)\nat com.dianping.zebra.single.jdbc.SingleStatement$8.executeSingleStatement(SingleStatement.java:212)\nat com.dianping.zebra.filter.DefaultJdbcFilter.executeSingleStatement(DefaultJdbcFilter.java:60)\nat com.dianping.zebra.single.jdbc.SingleStatement$8.executeSingleStatement(SingleStatement.java:212)\nat com.dianping.zebra.filter.DefaultJdbcFilter.executeSingleStatement(DefaultJdbcFilter.java:60)\nat com.dianping.zebra.single.jdbc.SingleStatement$8.executeSingleStatement(SingleStatement.java:212)\nat com.dianping.zebra.monitor.filter.CatFilter.executeSingleStatement(CatFilter.java:261)\nat com.dianping.zebra.single.jdbc.SingleStatement$8.executeSingleStatement(SingleStatement.java:212)\nat com.dianping.zebra.single.jdbc.SingleStatement.executeWithFilter(SingleStatement.java:220)\nat com.dianping.zebra.single.jdbc.SinglePreparedStatement.executeUpdate(SinglePreparedStatement.java:80)\nat com.dianping.zebra.group.jdbc.GroupPreparedStatement.executeUpdateOnConnection(GroupPreparedStatement.java:177)\nat com.dianping.zebra.group.jdbc.GroupPreparedStatement.executeUpdate(GroupPreparedStatement.java:161)\nat com.dianping.zebra.group.jdbc.GroupPreparedStatement.execute(GroupPreparedStatement.java:100)\n")])])]),a("p",[e._v("å½“æ—¶ä¸€ç‚¹æƒŠè®¶ï¼Œæœ‰æœ‰ä¸€ç‚¹å…´å¥‹ï¼Œæ¯•ç«Ÿæ˜¯ç¬¬ä¸€æ¬¡ç¢°åˆ°è¿™ç§äº‹ï¼Œå¤šæ–°é²œå•Šï¼Œèƒ½ä¸å…´å¥‹å—ï¼ŸğŸ˜‚"),a("br"),e._v("\nä»æŠ¥é”™ä¿¡æ¯å¯ä»¥çœ‹å‡ºï¼Œå¤§æ¦‚æ˜¯æŸä¸€ä¸ªäº‹åŠ¡ä¸€ç›´æ‹¿ä¸åˆ°é”ï¼ˆå‘ç°æ­»é”ï¼‰ï¼Œå°±å›æ»šäº†ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªæ“ä½œç®—æ˜¯æ— æ•ˆäº†ã€‚"),a("br"),e._v("\nè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å†å»çœ‹çœ‹æ­»é”ç›¸å…³äº‹åŠ¡çš„æ—¥å¿—")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("------------------------\nLATEST DETECTED DEADLOCK\n------------------------\n2019-08-01 12:04:43 0x7fc55ee5c700\n*** (1) TRANSACTION:\nTRANSACTION 4795708646, ACTIVE 0 sec fetching rows\nmysql tables in use 1, locked 1\nLOCK WAIT 12 lock struct(s), heap size 1136, 27 row lock(s)\nMySQL thread id 47505621, OS thread handle 140469423318784, query id 25961909428 10.64.129.102 activity updating\n/*id:f2de8e66*/update Bwc_Win_Candidate\n     SET state = 2 \n     WHERE (  activity_id = '1310731492'\n                  and user_id = 85***208\n                  and extra_id = '1310731492'\n                  and extra_type = 1 )\n*** (1) WAITING FOR THIS LOCK TO BE GRANTED:\nRECORD LOCKS space id 316 page no 316 n bits 256 index PRIMARY of table `DPCityActivity`.`Bwc_Win_Candidate` trx id 4795708646 lock_mode X locks rec but not gap waiting\n*** (2) TRANSACTION:\nTRANSACTION 4795708632, ACTIVE 0 sec fetching rows\nmysql tables in use 1, locked 1\n160 lock struct(s), heap size 24784, 29593 row lock(s)\nMySQL thread id 47507030, OS thread handle 140485677401856, query id 25961909390 10.81.65.15 activity updating\n/*id:f2de8e66*/update Bwc_Win_Candidate\n     SET state = 2 \n     WHERE (  activity_id = '1034085677'\n                  and user_id = 15***741\n                  and extra_id = '1034085677'\n                  and extra_type = 1 )\n*** (2) HOLDS THE LOCK(S):\nRECORD LOCKS space id 316 page no 316 n bits 256 index PRIMARY of table `DPCityActivity`.`Bwc_Win_Candidate` trx id 4795708632 lock_mode X\n*** (2) WAITING FOR THIS LOCK TO BE GRANTED:\nRECORD LOCKS space id 316 page no 317 n bits 256 index PRIMARY of table `DPCityActivity`.`Bwc_Win_Candidate` trx id 4795708632 lock_mode X waiting\n*** WE ROLL BACK TRANSACTION (1)\n")])])]),a("p",[e._v("è¯´æ˜¯çœ‹æ—¥å¿—ï¼Œå‰ææ˜¯çœ‹å¾—æ‡‚æ—¥å¿—å‘€ï¼Œæˆ‘å…ˆæ¥ä¸€æ­¥ä¸€æ­¥ææ‡‚æ—¥å¿—çš„å«ä¹‰å§")]),e._v(" "),a("h2",{attrs:{id:"æ­»é”æ—¥å¿—åˆ†æ"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#æ­»é”æ—¥å¿—åˆ†æ"}},[e._v("#")]),e._v(" æ­»é”æ—¥å¿—åˆ†æ")]),e._v(" "),a("p",[e._v("(1) TRANSACTION: "),a("em",[e._v("äº‹åŠ¡1")]),a("br"),e._v(" "),a("strong",[e._v("TRANSACTION 4795708646, ACTIVE 0 sec fetching rows")]),a("br"),e._v("\näº‹åŠ¡ç¼–å·4795708646ï¼Œæ´»è·ƒ0ç§’ï¼Œfetching rowsè¡¨ç¤ºäº‹åŠ¡çŠ¶æ€ï¼š"),a("br")]),e._v(" "),a("ul",[a("li",[e._v("fetching rows è¡¨ç¤ºäº‹åŠ¡çŠ¶æ€åœ¨row_search_for_mysqlä¸­è¢«è®¾ç½®ï¼Œè¡¨ç¤ºæ­£åœ¨æŸ¥æ‰¾è®°å½•ã€‚")]),e._v(" "),a("li",[e._v("updating or deleting è¡¨ç¤ºäº‹åŠ¡å·²ç»çœŸæ­£è¿›å…¥äº†Update/deleteçš„å‡½æ•°é€»è¾‘ï¼ˆrow_update_for_mysqlï¼‰")]),e._v(" "),a("li",[e._v("thread declared inside InnoDB è¯´æ˜äº‹åŠ¡å·²ç»è¿›å…¥innodbå±‚ã€‚é€šå¸¸è€Œè¨€ ä¸åœ¨innodbå±‚çš„äº‹åŠ¡å¤§éƒ¨åˆ†æ˜¯ä¼šè¢«å›æ»šçš„ã€‚")]),e._v(" "),a("li",[e._v("starting index read è¡¨ç¤ºæ ¹æ®ç´¢å¼•è¯»å–æ•°æ®ã€‚")])]),e._v(" "),a("p",[e._v("å°±æ˜¯è¯´äº‹åŠ¡1åœ¨æŸ¥æ‰¾è®°å½•è¿™ä¸ªçŠ¶æ€æ´»è·ƒæ—¶é—´æ˜¯0sã€‚"),a("br"),e._v(" "),a("strong",[e._v("mysql tables in use 1, locked 1")]),a("br"),e._v("\nè¯´æ˜å½“å‰çš„äº‹åŠ¡ä½¿ç”¨ä¸€ä¸ªè¡¨ã€‚locked 1 è¡¨ç¤ºè¡¨ä¸Šæœ‰ä¸€ä¸ªè¡¨é”,å¯¹äºDMLè¯­å¥ä¸º"),a("a",{attrs:{href:"https://dev.mysql.com/doc/refman/5.7/en/innodb-locking.html"}},[e._v("LOCK_IX")]),e._v(" "),a("br")]),e._v(" "),a("p",[a("strong",[e._v("LOCK WAIT 12 lock struct(s), heap size 1136, 27 row lock(s)")]),e._v(" "),a("br"),e._v("\nLOCK WAITè¡¨ç¤ºæ­£åœ¨ç­‰å¾…é”, 2 lock struct(s) è¡¨ç¤ºtrx->trx_locksé”é“¾è¡¨çš„é•¿åº¦ä¸º12ï¼Œæ¯ä¸ªé“¾è¡¨èŠ‚ç‚¹ä»£è¡¨è¯¥äº‹åŠ¡æŒæœ‰çš„ä¸€ä¸ªé”ç»“æ„ï¼ŒåŒ…æ‹¬è¡¨é”ï¼Œè®°å½•é”ä»¥åŠauto_incé”ç­‰ã€‚æœ¬æ¡ˆä¾‹ä¸­12locks è¡¨ç¤ºIXé”å’Œlock_mode X("),a("a",{attrs:{href:"https://blog.csdn.net/albertfly/article/details/78493245"}},[e._v("Next-key lock")]),e._v(")"),a("br"),e._v("\nheap size 1136 è¡¨ç¤ºäº‹åŠ¡åˆ†é…çš„é”å †å†…å­˜å¤§å°,ä¸€èˆ¬æ²¡æœ‰ä»€ä¹ˆå…·ä½“çš„ç”¨å¤„ã€‚"),a("br"),e._v("\n27 row lock(s)è¡¨ç¤ºå½“å‰äº‹åŠ¡æŒæœ‰çš„è¡Œè®°å½•é”/gap é”çš„ä¸ªæ•°ã€‚"),a("br")]),e._v(" "),a("p",[a("strong",[e._v("MySQL thread id 47507030, OS thread handle 140485677401856, query id 25961909390 10.81.65.15 activity updating")]),e._v("\nè¡¨ç¤ºä¸€äº›ipåœ°å€ï¼Œçº¿ç¨‹idç­‰ä¿¡æ¯ï¼ŒåŸºæœ¬æ²¡å•¥ç”¨ã€‚"),a("br")]),e._v(" "),a("p",[a("strong",[e._v("update Bwc_Win_Candidate SET state = 2 WHERE (  activity_id = '1034085677'and user_id = 15741 and extra_id ='1034085677' and extra_type = 1 )")]),e._v(" "),a("br"),e._v("\nè¡¨ç¤ºäº‹åŠ¡1æ­£åœ¨æ‰§è¡Œçš„sqlï¼Œé€šå¸¸æ˜¾ç¤ºæ­£åœ¨ç­‰å¾…é”çš„sqlã€‚"),a("br")]),e._v(" "),a("p",[a("strong",[e._v("WAITING FOR THIS LOCK TO BE GRANTED")]),e._v(" "),a("br"),e._v("\nè¡¨ç¤ºäº‹åŠ¡1ç­‰åœ¨ç­‰å¾…é”ã€‚"),a("br")]),e._v(" "),a("p",[a("strong",[e._v("RECORD LOCKS space id 316 page no 316 n bits 256 index PRIMARY of table "),a("code",[e._v("DPCityActivity")]),e._v("."),a("code",[e._v("Bwc_Win_Candidate")]),e._v(" trx id 4795708646 lock_mode X locks rec but not gap waiting")]),e._v(" "),a("br"),e._v("\nRECORD LOCKS è¡¨ç¤ºè®°å½•é”ï¼Œspace id ä¸º316ï¼ˆå¯¹åº”çš„èšé›†ç´¢å¼•ï¼‰ï¼Œpageå·ä¸º4ï¼Œn bits 256 è¡¨ç¤ºè¿™ä¸ªèšé›†ç´¢å¼•è®°å½•é”ä¸Šç•™æœ‰256ä¸ªBitä½ã€‚åé¢è¡¨ç¤ºæ­£åœ¨ç­‰å¾…Bwc_Win_Candidateè¡¨ä¸­çš„ä¸»é”®PRIMARYä¸Šçš„Xé”é‡Šæ”¾ã€‚"),a("br"),e._v("\nåˆ†æåé¢çš„æ—¥å¿—ï¼Œå¯ä»¥çœ‹åˆ°äº‹åŠ¡äºŒæŒæœ‰29593ä¸ªè¡Œé”"),a("br")]),e._v(" "),a("p",[a("strong",[e._v("HOLDS THE LOCK(S):RECORD LOCKS space id 316 page no 316 n bits 256 index PRIMARY of table "),a("code",[e._v("DPCityActivity")]),e._v("."),a("code",[e._v("Bwc_Win_Candidate")]),e._v(" trx id 4795708632 lock_mode X")]),e._v("\näº‹åŠ¡2 æŒæœ‰ä¸»é”®PRIMARYç´¢å¼•ï¼ˆindex PRIMARY ï¼‰ä¸Šçš„é”èµ„æº,space idä¸º316"),a("br")]),e._v(" "),a("p",[a("strong",[e._v(") WAITING FOR THIS LOCK TO BE GRANTED:RECORD LOCKS space id 316 page no 317 n bits 256 index PRIMARY of table "),a("code",[e._v("DPCityActivity")]),e._v("."),a("code",[e._v("Bwc_Win_Candidate")]),e._v(" trx id 4795708632")]),e._v(" "),a("br"),e._v("\näº‹åŠ¡2åœ¨ç­‰å¾…ä¸»é”®PRIMARYä¸Šçš„ç´¢å¼•çš„Xé”é‡Šæ”¾ã€‚"),a("br"),e._v(" "),a("strong",[e._v("WE ROLL BACK TRANSACTION (1)")]),e._v(" "),a("br"),e._v("\näº‹åŠ¡1å›æ»šã€‚")]),e._v(" "),a("p",[e._v("ä»æ—¥å¿—å¯ä»¥åˆ†æå‡ºï¼š"),a("br"),e._v("\näº‹åŠ¡1åœ¨æ‰§è¡Œsql 1çš„æ—¶å€™å‘ç”Ÿæ­»é”ï¼Œè¯´æ˜sql 1å¯¹åº”çš„è¡Œè®°å½•çš„é”è¢«äº‹åŠ¡2å æœ‰ï¼› "),a("br"),e._v("\näº‹åŠ¡2åœ¨æ‰§è¡Œsql 2çš„æ—¶å€™å‘ç”Ÿæ­»é”ï¼Œè¯´æ˜sql 2å¯¹åº”çš„è¡Œè®°å½•çš„é”è¢«äº‹åŠ¡1å æœ‰ï¼›"),a("br"),e._v(" "),a("img",{attrs:{src:"http://p0.meituan.net/scarlett/2210520a58f4709d36a63e2778524a0a41841.jpg",width:"50%",height:"auto",div:"",align:"right/"}}),e._v(" "),a("br"),e._v("\nå°±æ˜¯è¯´sqlæ‰«æå‘½ä¸­çš„è¡Œæ•°è¿‡å¤šï¼Œå¯¼è‡´åŠ é”çš„è¡Œæ•°è¿‡å¤šï¼Œåœ¨é«˜å¹¶å‘æƒ…å†µä¸‹ï¼Œå‘ç”Ÿäº†æ­»é”ã€‚")]),e._v(" "),a("h2",{attrs:{id:"åˆ†æsql"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#åˆ†æsql"}},[e._v("#")]),e._v(" åˆ†æsql")]),e._v(" "),a("p",[e._v("è¡¨ç»“æ„ï¼š")]),e._v(" "),a("blockquote",[a("p",[e._v("PRIMARY KEY ("),a("code",[e._v("id")]),e._v("),"),a("br"),e._v("\nUNIQUE KEY "),a("code",[e._v("UK_A_B_U")]),e._v(" ("),a("code",[e._v("activity_id")]),e._v(","),a("code",[e._v("business_key")]),e._v(","),a("code",[e._v("user_id")]),e._v("),"),a("br"),e._v("\nKEY "),a("code",[e._v("IX_UpdateTime")]),e._v(" ("),a("code",[e._v("updateTime")]),e._v(")")])]),e._v(" "),a("p",[e._v("å†çœ‹æˆ‘å†™çš„sqlè¯­å¥:")]),e._v(" "),a("blockquote",[a("p",[e._v("update Bwc_Win_CandidateSET state = 2 WHERE (  activity_id = '1034085677' and user_id = 15***741 and extra_id = '1034085677 and extra_type = 1 )")])]),e._v(" "),a("p",[e._v("å¯ä»¥å‘ç°é—®é¢˜ï¼Œè™½ç„¶è¡¨ä¸­æœ‰äº†å”¯ä¸€ç´¢å¼•ï¼Œä½†æ˜¯åœ¨æ›´æ–°æŸ¥è¯¢æ—¶å¹¶ä¸èƒ½å‘½ä¸­å”¯ä¸€ç´¢å¼•ï¼Œå› ä¸ºwhereæ¡ä»¶é‡Œé¢ç¼ºå°‘business_keyå­—æ®µï¼Œæ— æ³•å‘½ä¸­å”¯ä¸€ç´¢å¼•ï¼Œå°±å½“æ˜¯æ™®é€šç´¢å¼•äº†ï¼Œæ‰€ä»¥æŸ¥è¯¢æ‰«ææ˜¯å‘½ä¸­çš„è¡Œæ•°æ‰è¿‡å¤šã€‚"),a("a",{attrs:{href:"https://my.oschina.net/u/945573/blog/2985834"}},[e._v("è”åˆç´¢å¼•åŸç†è§£æ")])]),a("hr"),e._v("\nè§£å†³æ–¹æ¡ˆï¼šåœ¨æŸ¥è¯¢çš„è¿‡ç¨‹ä¸­åŠ å…¥business_keyå­—æ®µï¼Œä¿è¯å…¨éƒ¨å‘½ä¸­è”åˆå”¯ä¸€ç´¢å¼•ã€‚"),a("p")])}),[],!1,null,null,null);t.default=i.exports}}]);