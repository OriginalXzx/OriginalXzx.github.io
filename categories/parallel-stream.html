<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>java8并行流详解 | originalxzx</title>
    <meta name="description" content="Do your best, listen to your destiny.">
    
    
    <link rel="preload" href="/assets/css/0.styles.9b7d2f06.css" as="style"><link rel="preload" href="/assets/js/app.bc3533d3.js" as="script"><link rel="preload" href="/assets/js/4.3246cf6a.js" as="script"><link rel="preload" href="/assets/js/1.4b387ef0.js" as="script"><link rel="preload" href="/assets/js/50.e66fa8af.js" as="script"><link rel="prefetch" href="/assets/js/10.5a07acb6.js"><link rel="prefetch" href="/assets/js/11.6db78610.js"><link rel="prefetch" href="/assets/js/12.b582827c.js"><link rel="prefetch" href="/assets/js/13.68cdd812.js"><link rel="prefetch" href="/assets/js/14.da9ec9bd.js"><link rel="prefetch" href="/assets/js/15.537fbde0.js"><link rel="prefetch" href="/assets/js/16.bed91d5e.js"><link rel="prefetch" href="/assets/js/17.d7abcb8e.js"><link rel="prefetch" href="/assets/js/18.31bf4703.js"><link rel="prefetch" href="/assets/js/19.3d0540f3.js"><link rel="prefetch" href="/assets/js/20.b7b95bba.js"><link rel="prefetch" href="/assets/js/21.b1525f58.js"><link rel="prefetch" href="/assets/js/22.74c56685.js"><link rel="prefetch" href="/assets/js/23.e05d4ed1.js"><link rel="prefetch" href="/assets/js/24.8393159a.js"><link rel="prefetch" href="/assets/js/25.cb3fcfa5.js"><link rel="prefetch" href="/assets/js/26.a72c979e.js"><link rel="prefetch" href="/assets/js/27.52ce487e.js"><link rel="prefetch" href="/assets/js/28.2645ac11.js"><link rel="prefetch" href="/assets/js/29.0b97d374.js"><link rel="prefetch" href="/assets/js/30.5f2a8054.js"><link rel="prefetch" href="/assets/js/31.85fef366.js"><link rel="prefetch" href="/assets/js/32.746fe5f3.js"><link rel="prefetch" href="/assets/js/33.10f1dec1.js"><link rel="prefetch" href="/assets/js/34.1301481b.js"><link rel="prefetch" href="/assets/js/35.d148349e.js"><link rel="prefetch" href="/assets/js/36.f40b96b8.js"><link rel="prefetch" href="/assets/js/37.03db8746.js"><link rel="prefetch" href="/assets/js/38.f413eb02.js"><link rel="prefetch" href="/assets/js/39.7a712ab4.js"><link rel="prefetch" href="/assets/js/40.37627ca1.js"><link rel="prefetch" href="/assets/js/41.aaa97500.js"><link rel="prefetch" href="/assets/js/42.96074a0d.js"><link rel="prefetch" href="/assets/js/43.8e52a380.js"><link rel="prefetch" href="/assets/js/44.c8a4a8ce.js"><link rel="prefetch" href="/assets/js/45.e504aaa3.js"><link rel="prefetch" href="/assets/js/46.4233ad42.js"><link rel="prefetch" href="/assets/js/47.edc24500.js"><link rel="prefetch" href="/assets/js/48.bea852cc.js"><link rel="prefetch" href="/assets/js/49.090490ed.js"><link rel="prefetch" href="/assets/js/5.ad2fccbd.js"><link rel="prefetch" href="/assets/js/51.a9d53c70.js"><link rel="prefetch" href="/assets/js/52.5d9e5954.js"><link rel="prefetch" href="/assets/js/53.c2a57b23.js"><link rel="prefetch" href="/assets/js/54.200dfb09.js"><link rel="prefetch" href="/assets/js/55.50e28dae.js"><link rel="prefetch" href="/assets/js/56.69f79320.js"><link rel="prefetch" href="/assets/js/57.261e564c.js"><link rel="prefetch" href="/assets/js/58.c192e345.js"><link rel="prefetch" href="/assets/js/59.d5b4faab.js"><link rel="prefetch" href="/assets/js/6.870d525b.js"><link rel="prefetch" href="/assets/js/60.0592c12c.js"><link rel="prefetch" href="/assets/js/7.e36ca661.js"><link rel="prefetch" href="/assets/js/8.3bccdd02.js"><link rel="prefetch" href="/assets/js/9.20671d54.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.abb00470.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9b7d2f06.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="theme-container" data-v-4698c43e><div data-v-4698c43e><div id="loader-wrapper" class="loading-wrapper" data-v-4b73742e data-v-4698c43e data-v-4698c43e><div class="loader-main" data-v-4b73742e><div data-v-4b73742e></div><div data-v-4b73742e></div><div data-v-4b73742e></div><div data-v-4b73742e></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-6cbeab0a data-v-4698c43e data-v-4698c43e><h3 class="title" style="display:none;" data-v-6cbeab0a data-v-6cbeab0a>originalxzx</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-6cbeab0a data-v-6cbeab0a><input type="password" value="" data-v-6cbeab0a> <span data-v-6cbeab0a>Konck! Knock!</span> <button data-v-6cbeab0a>OK</button></label> <div class="footer" style="display:none;" data-v-6cbeab0a data-v-6cbeab0a><span data-v-6cbeab0a><i class="iconfont reco-theme" data-v-6cbeab0a></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-6cbeab0a>vuePress-theme-reco</a></span> <span data-v-6cbeab0a><i class="iconfont reco-copyright" data-v-6cbeab0a></i> <a data-v-6cbeab0a><span data-v-6cbeab0a>originalxzx</span>
            
          <!---->
          2020
        </a></span></div></div> <div class="hide" data-v-4698c43e><header class="navbar" data-v-4698c43e><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">originalxzx</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/arts/" class="nav-link"><i class="iconfont undefined"></i>
  arts
</a></li><li class="dropdown-item"><!----> <a href="/categories/backEnd/" class="nav-link"><i class="iconfont undefined"></i>
  backEnd
</a></li><li class="dropdown-item"><!----> <a href="/categories/travel/" class="nav-link"><i class="iconfont undefined"></i>
  travel
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-blog"></i>
      tools
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://cli.im/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  二维码生成器
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-4698c43e></div> <aside class="sidebar" data-v-4698c43e><div class="personal-info-wrapper" data-v-6c8ffc9c><!----> <h3 class="name" data-v-6c8ffc9c>
    originalxzx
  </h3> <div class="num" data-v-6c8ffc9c><div data-v-6c8ffc9c><h3 data-v-6c8ffc9c>42</h3> <h6 data-v-6c8ffc9c>文章</h6></div> <div data-v-6c8ffc9c><h3 data-v-6c8ffc9c>15</h3> <h6 data-v-6c8ffc9c>标签</h6></div></div> <hr data-v-6c8ffc9c></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/arts/" class="nav-link"><i class="iconfont undefined"></i>
  arts
</a></li><li class="dropdown-item"><!----> <a href="/categories/backEnd/" class="nav-link"><i class="iconfont undefined"></i>
  backEnd
</a></li><li class="dropdown-item"><!----> <a href="/categories/travel/" class="nav-link"><i class="iconfont undefined"></i>
  travel
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-blog"></i>
      tools
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://cli.im/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  二维码生成器
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>java8并行流详解</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/categories/parallel-stream.html#一、java8-stream" class="sidebar-link">一、java8 stream</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/categories/parallel-stream.html#_1-1-初识流" class="sidebar-link">1.1 初识流</a></li><li class="sidebar-sub-header"><a href="/categories/parallel-stream.html#_1-2-流简介" class="sidebar-link">1.2 流简介</a></li><li class="sidebar-sub-header"><a href="/categories/parallel-stream.html#_1-3-流与集合" class="sidebar-link">1.3 流与集合</a></li><li class="sidebar-sub-header"><a href="/categories/parallel-stream.html#_1-4-流操作" class="sidebar-link">1.4 流操作</a></li><li class="sidebar-sub-header"><a href="/categories/parallel-stream.html#_1-5-用流收集数据" class="sidebar-link">1.5 用流收集数据</a></li></ul></li><li><a href="/categories/parallel-stream.html#二、parallel-stream" class="sidebar-link">二、parallel stream</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/categories/parallel-stream.html#_2-1-fork-join-框架" class="sidebar-link">2.1 Fork/Join 框架</a></li><li class="sidebar-sub-header"><a href="/categories/parallel-stream.html#_2-2-工作窃取" class="sidebar-link">2.2 工作窃取</a></li><li class="sidebar-sub-header"><a href="/categories/parallel-stream.html#_2-3-spliterator" class="sidebar-link">2.3 Spliterator</a></li><li class="sidebar-sub-header"><a href="/categories/parallel-stream.html#_2-4-高效的使用并行流" class="sidebar-link">2.4 高效的使用并行流</a></li></ul></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-6cbeab0a data-v-4698c43e><h3 class="title" style="display:none;" data-v-6cbeab0a data-v-6cbeab0a>java8并行流详解</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-6cbeab0a data-v-6cbeab0a><input type="password" value="" data-v-6cbeab0a> <span data-v-6cbeab0a>Konck! Knock!</span> <button data-v-6cbeab0a>OK</button></label> <div class="footer" style="display:none;" data-v-6cbeab0a data-v-6cbeab0a><span data-v-6cbeab0a><i class="iconfont reco-theme" data-v-6cbeab0a></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-6cbeab0a>vuePress-theme-reco</a></span> <span data-v-6cbeab0a><i class="iconfont reco-copyright" data-v-6cbeab0a></i> <a data-v-6cbeab0a><span data-v-6cbeab0a>originalxzx</span>
            
          <!---->
          2020
        </a></span></div></div> <div data-v-4698c43e><main class="page"><!----> <div class="page-title" style="display:none;"><h1>java8并行流详解</h1> <hr> <div data-v-484a899e><i class="iconfont reco-account" data-v-484a899e><span data-v-484a899e>originalxzx</span></i> <i class="iconfont reco-date" data-v-484a899e><span data-v-484a899e>2020-04-16</span></i> <i class="iconfont reco-eye" data-v-484a899e><span id="/categories/parallel-stream.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-484a899e><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="iconfont reco-tag tags" data-v-484a899e><span class="tag-item" data-v-484a899e>
      java
    </span><span class="tag-item" data-v-484a899e>
      后端
    </span><span class="tag-item" data-v-484a899e>
      stream
    </span><span class="tag-item" data-v-484a899e>
      并行
    </span></i></div></div> <div class="theme-reco-content content__default" style="display:none;"><div class="custom-block tip"><p>Java 8 API添加了一个新的抽象称为流Stream，可以让你以一种声明的方式处理数据，极大提高了了开发人员生产力，而在流的基础上又增加了并行流，大大简化了开发人员多线程编码的过程，让开发人员可以写出高效率、干净、简洁的代码，本篇文章将会带你由浅至深的理解java8并行流。</p></div> <h2 id="一、java8-stream"><a href="#一、java8-stream" class="header-anchor">#</a> 一、java8 stream</h2> <h3 id="_1-1-初识流"><a href="#_1-1-初识流" class="header-anchor">#</a> 1.1 初识流</h3> <p>流是Java API的新成员，它允许你以声明性方式处理数据集合(通过查询语句来表达，而不是临时编写一个实现)。就现在来说，你可以把它们看成遍历数据集的高级迭代器，下面用一个例子初始流的美妙之处。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Dish</span><span class="token punctuation">&gt;</span></span> lowCaloricDishes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//过滤掉热量大于等于400的菜</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Dish</span> d<span class="token operator">:</span> menu<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span><span class="token function">getCalories</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   lowCaloricDishes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//对剩下的菜按照热量进行排序</span>
<span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>lowCaloricDishes<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Dish</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compare</span><span class="token punctuation">(</span><span class="token class-name">Dish</span> d1<span class="token punctuation">,</span> <span class="token class-name">Dish</span> d2<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>d1<span class="token punctuation">.</span><span class="token function">getCalories</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> d2<span class="token punctuation">.</span><span class="token function">getCalories</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//获取最终需要的菜名</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> lowCaloricDishesName <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Dish</span> d<span class="token operator">:</span> lowCaloricDishes<span class="token punctuation">)</span><span class="token punctuation">{</span>
    lowCaloricDishesName<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>注意，这里面有一个中间变量 <code>lowCaloricDishes</code> ，他的唯一作用是一次性的中间容器，在java8之前又不可缺少，但是用java8流来实现就不需要这个了。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> owCaloricDishesName <span class="token operator">=</span> 
              menu<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>d <span class="token operator">-&gt;</span> d<span class="token punctuation">.</span><span class="token function">getCalories</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">400</span><span class="token punctuation">)</span>   <span class="token comment">//过滤</span>
                <span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token function">comparing</span><span class="token punctuation">(</span><span class="token class-name">Dish</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">getCalories</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//排序</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Dish</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">getName</span><span class="token punctuation">)</span>                   <span class="token comment">//取值</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如果数据量大，也可以利用机器多核的能力并行执行这段代码，只要把<code>stream</code>替换成<code>parallelStream</code>：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> owCaloricDishesName <span class="token operator">=</span> 
              menu<span class="token punctuation">.</span><span class="token function">parallelStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>d <span class="token operator">-&gt;</span> d<span class="token punctuation">.</span><span class="token function">getCalories</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">400</span><span class="token punctuation">)</span>   <span class="token comment">//过滤</span>
                <span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token function">comparing</span><span class="token punctuation">(</span><span class="token class-name">Dish</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">getCalories</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//排序</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Dish</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">getName</span><span class="token punctuation">)</span>                   <span class="token comment">//取值</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这个时候可能最大的疑问在于，调用parallelStream跟stream区别是啥，调用的时候发生了什么，用了多少线程，对性能提升了多少，这些问题也是本文研究的重点。但是现在，作为一个java开发人员应该能够体会到stream的美妙了吧。
总结下来就是：</p> <ul><li>声明性 - 更简洁，更易懂</li> <li>可复合 - 更灵活</li> <li>可并行 - 性能更好</li></ul> <h3 id="_1-2-流简介"><a href="#_1-2-流简介" class="header-anchor">#</a> 1.2 流简介</h3> <p>流到底是什么呢?简短的定义就是“从支持数据处理操作的源生成的元素序列”。先来剖析一下流的定义：</p> <ol><li><strong>元素序列</strong> - 就像集合一样，流也提供了一个接口，可以访问特定元素类型的一组有序值，跟集合同步的是流讲的计算，而集合讲的数据。</li> <li><strong>源</strong> - 流会使用一个提供数据的源,这是不可缺少的。</li> <li><strong>数据处理操作</strong> - 流的数据处理功能支持类似于数据库的操作，以及函数式编程语言中 的常用操作，如filter、map、reduce、find、match、sort等。</li> <li><strong>流水线</strong> - 很多流操作本身会返回一个流，这样多个操作就可以链接起来，形成一个大
的流水线。</li> <li><strong>内部迭代</strong> -流的迭代操作是在背后进行的。</li></ol> <p>继续以‘查找热量最高的三道 菜的菜名’为例，简单看一下流的执行过程</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> owCaloricDishesName <span class="token operator">=</span> 
              menu<span class="token punctuation">.</span><span class="token function">parallelStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>d <span class="token operator">-&gt;</span> d<span class="token punctuation">.</span><span class="token function">getCalories</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">400</span><span class="token punctuation">)</span>   <span class="token comment">//过滤</span>
                <span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token function">comparing</span><span class="token punctuation">(</span><span class="token class-name">Dish</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">getCalories</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//排序</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Dish</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">getName</span><span class="token punctuation">)</span>                   <span class="token comment">//取值</span>
                <span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>                             <span class="token comment">//截断</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="http://p1.meituan.net/scarlett/9175e8a53a562fdc8cdd63ef1d3b8c54112375.png" alt="执行过程图"></p> <p>菜单给流提供一个元素序列。接下来，对流应用一系列数据处理操作:filter、sort、map、limit 和collect。除了collect之外，所有这些操作都会返回另一个流，这样它们就可以接成一条流水线，于是就可以看作对源的一个查询。最后，collect操作开始处理流水线，并返回结果(它和别的操作不一样，因为它返回的不是流，在这里是一个List)。在调用collect之前，没有任何结果产生，实际上根本就没有从menu里选择元素。这就是collect的神奇之处，可以先把collect看 作能够接受各种方案作为参数，并将流中的元素累积成为一个汇总结果的操作，下文中会简单介绍collect工作原理。</p> <h3 id="_1-3-流与集合"><a href="#_1-3-流与集合" class="header-anchor">#</a> 1.3 流与集合</h3> <p>粗略地说，集合与流之间的差异就在于什么时候进行计算。集合是一个内存中的数据结构， 它包含数据结构中目前所有的值——集合中的每个元素都得先算出来才能添加到集合中，流则是在概念上固定的数据结构，按需计算，就像存在DVD里的电影，这就是一个集合，因为它包含了整个数据结构。而互联网上通过视频流看同样的电影则不同，这是一个流(字节流或帧流)。流媒体视频播放器只要提前下载用户观看位置的那几帧就可以了，这样不用等到流中大部分值计算出来，你就可以显示流的开始部分了(想想观看直播足球赛)。
<img src="http://p0.meituan.net/scarlett/a7eeb38fc51c7b8dbe66970355c5feea426040.png" alt="流与集合"></p> <h3 id="_1-4-流操作"><a href="#_1-4-流操作" class="header-anchor">#</a> 1.4 流操作</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> owCaloricDishesName <span class="token operator">=</span> 
              menu<span class="token punctuation">.</span><span class="token function">parallelStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>d <span class="token operator">-&gt;</span> d<span class="token punctuation">.</span><span class="token function">getCalories</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">400</span><span class="token punctuation">)</span>   <span class="token comment">//过滤</span>
                <span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token function">comparing</span><span class="token punctuation">(</span><span class="token class-name">Dish</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">getCalories</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//排序</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Dish</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">getName</span><span class="token punctuation">)</span>                   <span class="token comment">//取值</span>
                <span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>                             <span class="token comment">//截断</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>仍然以上述代码为例，你可以看到两类操作:<br>
 filter、sort、map和limit可以连成一条流水线; <br>
 collect触发流水线执行并关闭它。<br>
可以连接起来的流操作称为中间操作，关闭流的操作称为终端操作。诸如filter或sorted等中间操作会返回另一个流,终端操作会从流的流水线生成结果。
<img src="http://p0.meituan.net/scarlett/1551af935fc3c1e4af50b57c6a0ba24b43172.png" alt="并行">
关于中间操作主要是一些流的使用，怎么样运用流做一下数据的计算，不是本文的讨论的重点，而为了重点介绍后面的内容，下面简单介绍用流收集数据。</p> <h3 id="_1-5-用流收集数据"><a href="#_1-5-用流收集数据" class="header-anchor">#</a> 1.5 用流收集数据</h3> <p>首先先看一下流常用收集API Collectors的实体关系图:
<img src="http://p0.meituan.net/scarlett/aa5921463d1ef2f80ae4b64bc4c355c9480313.png" alt="collectors">
可以看到我们平时使用的stream的终端操作都会定义在Collecters里面，而Collectors里面有一个内部类CollectorImpl，CollectorImpl实现了Collector接口。Collector接口包含了一系列方法，为实现具体的归约操作(即收集器)提供了范本。我们已经看过了Collector接口中实现的许多收集器，例如toList或groupingBy。所以我们先分析一下Collector接口。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">A</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">A</span><span class="token punctuation">&gt;</span></span> <span class="token function">supplier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BiConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">A</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">accumulator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">A</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token function">finisher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BinaryOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">A</span><span class="token punctuation">&gt;</span></span> <span class="token function">combiner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Characteristics</span><span class="token punctuation">&gt;</span></span> <span class="token function">characteristics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><strong>T</strong>是流中要收集的项目的泛型。</li> <li><strong>A</strong>是累加器的类型，累加器是在收集过程中用于累积部分结果的对象。</li> <li><strong>R</strong>是收集操作得到的对象(通常但并不一定是集合)的类型。
下面我们重点分析一下这五个方法。</li></ul> <h4 id="_1-建立新的结果容器-supplier方法"><a href="#_1-建立新的结果容器-supplier方法" class="header-anchor">#</a> 1. 建立新的结果容器:supplier方法</h4> <p>supplier方法必须返回一个结果为空的Supplier，也就是一个无参数函数，在调用时它会
创建一个空的累加器实例，供数据收集过程使用。比如我们使用的Collectors.toList中，ToListCollector里面supplier就返回一个空的List，如下所示：</p> <div class="language-java extra-class"><pre class="language-java"><code> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span>
    <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CollectorImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token class-name">ArrayList</span><span class="token operator">:</span><span class="token operator">:</span><span class="token keyword">new</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">add</span><span class="token punctuation">,</span>
                                   <span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span> left<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> left<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                                   CH_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>传参的第一个参数就是返回一个空List的Supplier</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">supplier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">ArrayList</span><span class="token operator">:</span><span class="token operator">:</span><span class="token keyword">new</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_2-将元素添加到结果容器-accumulator方法"><a href="#_2-将元素添加到结果容器-accumulator方法" class="header-anchor">#</a> 2. 将元素添加到结果容器:accumulator方法</h4> <p>accumulator方法会返回执行归约操作的函数。当遍历到流中第n个元素时，这个函数执行时会有两个参数:保存归约结果的累加器(已收集了流中的前n - 1个项目)，还有第n个元素本身。对于ToListCollector，这个函数仅仅会把当前项目添加至已经遍历过的项目的列表:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">BiConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">accumulator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">List</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">add</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_3-对结果容器应用最终转换-finisher方法"><a href="#_3-对结果容器应用最终转换-finisher方法" class="header-anchor">#</a> 3. 对结果容器应用最终转换:finisher方法</h4> <p>在遍历完流后，finisher方法必须返回在累积过程的最后要调用的一个函数，以便将累加器对象转换为整个集合操作的最终结果。通常，就像ToListCollector的情况一样，累加器对象恰好符合预期的最终结果，因此无需进行转换。所以finisher方法只需返回identity函数</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">finisher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Function</span><span class="token punctuation">.</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>以上三个方法已经足以对流进行顺序归约(收集)，从逻辑上看可以按照下图的逻辑了，实际上可能会复杂些。</p> <p><img src="http://p0.meituan.net/scarlett/5fe7f0a7c3854c4edbcec80a44186a6e135974.png" alt="收集"></p> <h4 id="_4-合并两个结果容器-combiner方法"><a href="#_4-合并两个结果容器-combiner方法" class="header-anchor">#</a> 4. 合并两个结果容器:combiner方法</h4> <p>combiner方法会返回一个供归约操作使用的函数，它定义了对流的各个子部分进行并行处理时，各个子部分归约所得的累加器要如何合并。对于toList而言， 这个方法的实现非常简单，只要把从流的第二个部分收集到的项目列表加到遍历第一部分时得到的列表后面就行了:</p> <div class="language-java extra-class"><pre class="language-java"><code> <span class="token keyword">public</span> <span class="token class-name">BinaryOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">combiner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>list1<span class="token punctuation">,</span> list2<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            list1<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>list2<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> list1<span class="token punctuation">;</span> 
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>有了这个方法就可以对流进行并行收集了，它会用到fork/join框架，在下文中会提到。<br>
使用combiner方法来并行化归约过程
<img src="http://p0.meituan.net/scarlett/e6e90ab4cf03e6d7b9c7ac5fa3727784271774.png" alt="combiner"></p> <h4 id="_5-characteristics方法"><a href="#_5-characteristics方法" class="header-anchor">#</a> 5. characteristics方法</h4> <p>最后一个方法——characteristics会返回一个不可变的Characteristics集合，它定义了收集器的行为——尤其是关于流是否可以并行归约，以及可以使用哪些优化的提示。</p> <h2 id="二、parallel-stream"><a href="#二、parallel-stream" class="header-anchor">#</a> 二、parallel stream</h2> <p>有了前面对流的认识，以及对流收集器的了解，并行流的概念也就呼之欲出了，并行流就是一个把内容分成多个数据块，并用不同的线程分别处理每个数据块的流。这样一来，你就可以自动把给定操作的工作负荷分配给多核处理器的所有内核，让它们都忙起来。<br>
通用的，我们先来看一个列子：<br>
接受数字n作为参数，并返回从1到给定参数的所有数字的和</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">sequentialSum</span><span class="token punctuation">(</span><span class="token keyword">long</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token keyword">return</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">iterate</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> i <span class="token operator">-&gt;</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">//生成自然数无限流</span>
                          <span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
                          <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">sum</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//求和</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当n很大的时候，就是一个很好利用并行流的机会了，那怎么入手呢?你要对结果变量进 行同步吗?用多少个线程呢?谁负责生成数呢?谁来做加法呢?根本用不着担心啦。用并行流的话，这问题就简单多了!</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">parallelSum</span><span class="token punctuation">(</span><span class="token keyword">long</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">iterate</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> i <span class="token operator">-&gt;</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
                     <span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
                     <span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>              <span class="token comment">//顺序流变成并行流</span>
                     <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">sum</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>和顺序流不同的是并行流把数据分成了多块，然后每块进行单独的计算，最后再归纳结果，如图所示：
<img src="http://p0.meituan.net/scarlett/3c7d58dc34877bdb599dba774cf9e164253542.png" alt="并行"></p> <blockquote><p>看看流的parallel方法，你可能会想，并行流用的线程是从哪儿来的?有多少个?怎么 自定义这个过程呢?<br></p></blockquote> <p>并行流内部使用了默认的ForkJoinPool，它默认的线程数量就是你的处理器数量，这个值是由Runtime.getRuntime().available-Processors()得到的。但是你可以通过通过System.setProperty(&quot;java.util.concurrent.ForkJoinPool.common.parallelism&quot;,&quot;12&quot;)来修改。这是一个全局设置，因此它将影响代码中所有的并行流。反过来说，目前还无法专为某个并行流指定这个值。一般而言,让ForkJoinPool的大小等于处理器数量是个不错的默认值，除非你有很好的理由，否则强烈建议你不要修改它。<br>
下面我们先看一下fork/join框架。</p> <h3 id="_2-1-fork-join-框架"><a href="#_2-1-fork-join-框架" class="header-anchor">#</a> 2.1 Fork/Join 框架</h3> <p>fork/join框架的目的是以递归方式将可以并行的任务拆分成更小的任务，然后将每个子任务的结果合并起来生成整体结果。它是ExecutorService接口的一个实现，它把子任务分配给线程池(ForkJoinPool)中的工作线程。fork、join过程如下：
<img src="http://p0.meituan.net/scarlett/60a45290e297a1f7a76fa63d2d8f56e1196959.png" alt="拆分"></p> <p>这里面实现的关键在于任务(RecursiveTask)的定义,要把任务提交到ForkJoinPool，必须创建一个RecursiveTask的子类,而要定义RecursiveTask，只需实现它唯一的抽象方法compute:<br> <strong>protected abstract R compute()</strong><br>
这个方法同时定义了将任务拆分成子任务的逻辑，以及无法再拆分或不方便再拆分时，生成 单个子任务结果的逻辑。可以用下面伪代码来表示：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>任务足够小或不可分<span class="token punctuation">)</span> <span class="token punctuation">{</span> 顺序计算该任务
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
     将任务分成两个子任务
     递归调用本方法，拆分每个子任务，等待所有子任务完成
     合并每个子任务的结果
<span class="token punctuation">}</span>
</code></pre></div><p>比如要定义求和一个数组，那么comput里面代码可以这么写</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ForkJoinSumCalculator</span> <span class="token keyword">extends</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span><span class="token class-name">RecursiveTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> numbers<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> start<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> end<span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> THRESHOLD <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span> <span class="token comment">//不再划分子任务的阈值</span>

  <span class="token keyword">public</span> <span class="token class-name">ForkJoinSumCalculator</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> numbers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span>numbers<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> numbers<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token class-name">ForkJoinSumCalculator</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> numbers<span class="token punctuation">,</span> <span class="token keyword">int</span> start<span class="token punctuation">,</span> <span class="token keyword">int</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">this</span><span class="token punctuation">.</span>numbers <span class="token operator">=</span> numbers<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>start <span class="token operator">=</span> start<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>end <span class="token operator">=</span> end<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">protected</span> <span class="token class-name">Long</span> <span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">int</span> length <span class="token operator">=</span> end <span class="token operator">-</span> start<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">&lt;=</span> THRESHOLD<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">computeSequentially</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">//递归</span>
      <span class="token class-name">ForkJoinSumCalculator</span> leftTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinSumCalculator</span><span class="token punctuation">(</span>numbers<span class="token punctuation">,</span> start<span class="token punctuation">,</span> start <span class="token operator">+</span> length<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      leftTask<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//递归</span>
      <span class="token class-name">ForkJoinSumCalculator</span> rightTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinSumCalculator</span><span class="token punctuation">(</span>numbers<span class="token punctuation">,</span> start <span class="token operator">+</span> length<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Long</span> rightResult <span class="token operator">=</span> rightTask<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Long</span> leftResult <span class="token operator">=</span> leftTask<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> leftResult <span class="token operator">+</span> rightResult<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">computeSequentially</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> start<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> end<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sum <span class="token operator">+=</span> numbers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> sum<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>要把任务交给ForkjoinPool运行起来就很简单了</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">forkJoinSum</span><span class="token punctuation">(</span><span class="token keyword">long</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> numbers <span class="token operator">=</span> <span class="token class-name">LongStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinSumCalculator</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对于fork/join拆分策略还有最后一点补充:必须选择一个标准，来决定任务是要进一步 拆分还是已小到可以顺序求值。</p> <h3 id="_2-2-工作窃取"><a href="#_2-2-工作窃取" class="header-anchor">#</a> 2.2 工作窃取</h3> <p>任务拆分最大的问题在于怎么样保证任务拆分的合理，能够让每个线程执行任务的时间都差不多，能够让cpu内核通用的繁忙。实际中，每个子任务所花的时间可能天差地别，要么是因为划分策略效率低，要么是有不可预知的原因，比如磁盘访问慢，或是需要和外部服务协调执行。所以就出现了工作窃取模式来解决这个问题。那么什么是工作窃取模式呢？</p> <p>每个线程都为 配给它的任务保存一个双向链式队列，每完成一个任务，就会从队列头上取出下一个任务开始执行。当某个线程可能早早完成了分配给它的所有任务，也就是它的队列已经空了，而其他的线程还很忙。这时，这个线程并没有闲下来，而是随机选了一个别的线程，从队列的尾巴上“偷走”一个任务。这个过程一直继续下去，直到所有的任务都执行完毕，所有的队列都清空。这就是为什么要划成许多小任务而不是少数几个大任务，这有助于更好地在工作线程之间平衡负载。如下图所示，当工作线程队列中有一个任务被分成两个子任务时，一个子任务就被闲置的工作线 程“偷走”了。
<img src="http://p0.meituan.net/scarlett/c03733b87e446a2a03ba8f4aba5f6be9166738.png" alt=""></p> <p>我们在使用并行流的时候为什么没有定义任务拆分呢，那是因为有自动拆分的机制，这个机制叫<strong>Spliterator</strong> 。</p> <h3 id="_2-3-spliterator"><a href="#_2-3-spliterator" class="header-anchor">#</a> 2.3 Spliterator</h3> <p>Java 8已经为集合框架中包含的所有数据结构提供了一个默认的Spliterator实现。集合实现了Spliterator接口，接口提供了一个spliterator方法。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Spliterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> <span class="token function">tryAdvance</span><span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Spliterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">trySplit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> <span class="token function">estimateSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> <span class="token function">characteristics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>tryAdvance方法的行为类似于普通的 Iterator，因为它会按顺序一个一个使用Spliterator中的元素，并且如果还有其他元素要遍 历就返回true。</li> <li>trySplit是专为Spliterator接口设计的，因为它可以把一些元素划出去分 给第二个Spliterator。</li> <li>estimateSize方法估计还剩下多少元素要遍历,为了拆分得均匀一些</li> <li>characteristics是Spliterator自身定义的一项特性。
Spliterato递归拆分过程如下：
<img src="http://p0.meituan.net/scarlett/51f923d2fd7fc3a626ec6347a2280a03211762.png" alt="">
这个拆分过程也受Spliterator本身的特性(比如元素有既定的顺序(例如List)，因此Spliterator在遍历和划分时也会遵循这一顺序)影响，而特性是通过characteristics方法声明的。</li></ul> <p>我们来看一下ArrayList下面定义的Spliterator</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ArrayListSpliterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">Spliterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> index<span class="token punctuation">;</span> <span class="token comment">// current index, modified on advance/split</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> fence<span class="token punctuation">;</span> <span class="token comment">// -1 until used; then one past last index</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> expectedModCount<span class="token punctuation">;</span> <span class="token comment">// initialized when fence set</span>

        <span class="token comment">/** Create new spliterator covering the given  range */</span>
        <span class="token class-name">ArrayListSpliterator</span><span class="token punctuation">(</span><span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">,</span> <span class="token keyword">int</span> origin<span class="token punctuation">,</span> <span class="token keyword">int</span> fence<span class="token punctuation">,</span>
                             <span class="token keyword">int</span> expectedModCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>list <span class="token operator">=</span> list<span class="token punctuation">;</span> <span class="token comment">// OK if null unless traversed</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>index <span class="token operator">=</span> origin<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>fence <span class="token operator">=</span> fence<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>expectedModCount <span class="token operator">=</span> expectedModCount<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">getFence</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// initialize fence to size on first use</span>
            <span class="token keyword">int</span> hi<span class="token punctuation">;</span> <span class="token comment">// (a specialized variant appears in method forEach)</span>
            <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> lst<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>hi <span class="token operator">=</span> fence<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>lst <span class="token operator">=</span> list<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    hi <span class="token operator">=</span> fence <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    expectedModCount <span class="token operator">=</span> lst<span class="token punctuation">.</span>modCount<span class="token punctuation">;</span>
                    hi <span class="token operator">=</span> fence <span class="token operator">=</span> lst<span class="token punctuation">.</span>size<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> hi<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token class-name">ArrayListSpliterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token function">trySplit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> hi <span class="token operator">=</span> <span class="token function">getFence</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lo <span class="token operator">=</span> index<span class="token punctuation">,</span> mid <span class="token operator">=</span> <span class="token punctuation">(</span>lo <span class="token operator">+</span> hi<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>lo <span class="token operator">&gt;=</span> mid<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token comment">// divide range in half unless too small</span>
                <span class="token keyword">new</span> <span class="token class-name">ArrayListSpliterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> lo<span class="token punctuation">,</span> index <span class="token operator">=</span> mid<span class="token punctuation">,</span>
                                            expectedModCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryAdvance</span><span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> action<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> hi <span class="token operator">=</span> <span class="token function">getFence</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> i <span class="token operator">=</span> index<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> hi<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                index <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span> <span class="token class-name">E</span> e <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">E</span><span class="token punctuation">)</span>list<span class="token punctuation">.</span>elementData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                action<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">.</span>modCount <span class="token operator">!=</span> expectedModCount<span class="token punctuation">)</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentModificationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">forEachRemaining</span><span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> action<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> i<span class="token punctuation">,</span> hi<span class="token punctuation">,</span> mc<span class="token punctuation">;</span> <span class="token comment">// hoist accesses and checks from loop</span>
            <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> lst<span class="token punctuation">;</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>lst <span class="token operator">=</span> list<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>a <span class="token operator">=</span> lst<span class="token punctuation">.</span>elementData<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>hi <span class="token operator">=</span> fence<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mc <span class="token operator">=</span> lst<span class="token punctuation">.</span>modCount<span class="token punctuation">;</span>
                    hi <span class="token operator">=</span> lst<span class="token punctuation">.</span>size<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span>
                    mc <span class="token operator">=</span> expectedModCount<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">=</span> index<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>index <span class="token operator">=</span> hi<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> a<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> hi<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span> <span class="token class-name">E</span> e <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">E</span><span class="token punctuation">)</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                        action<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>lst<span class="token punctuation">.</span>modCount <span class="token operator">==</span> mc<span class="token punctuation">)</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentModificationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">estimateSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">getFence</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">characteristics</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Spliterator</span><span class="token punctuation">.</span>ORDERED <span class="token operator">|</span> <span class="token class-name">Spliterator</span><span class="token punctuation">.</span>SIZED <span class="token operator">|</span> <span class="token class-name">Spliterator</span><span class="token punctuation">.</span>SUBSIZED<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-4-高效的使用并行流"><a href="#_2-4-高效的使用并行流" class="header-anchor">#</a> 2.4 高效的使用并行流</h3> <ol><li><p>并行流并不总是比顺序流快，所以在考虑选择顺序流还是并行流时，第一个也是最重要的建议就是用适当的基准来检查 其性能。</p></li> <li><p>留意装箱。自动装箱和拆箱操作会大大降低性能。Java 8中有原始类型流(IntStream、 LongStream、DoubleStream)来避免这种操作，但凡有可能都应该用这些流。</p></li> <li><p>有些操作本身在并行流上的性能就比顺序流差。特别是limit和findFirst等依赖于元 素顺序的操作，它们在并行流上执行的代价非常大。</p></li> <li><p>考虑流的操作流水线的总计算成本。设N是要处理的元素的总数，Q是一个元素通过 流水线的大致处理成本，则N*Q就是这个对成本的一个粗略的定性估计。Q值较高就意味 着使用并行流时性能好的可能性比较大。</p></li> <li><p>对于较小的数据量，选择并行流几乎从来都不是一个好的决定。</p></li> <li><p>要考虑流背后的数据结构是否易于分解。例如，ArrayList的拆分效率比LinkedList 高得多，因为前者用不着遍历就可以平均拆分，而后者则必须遍历</p></li> <li><p>流自身的特点，以及流水线中的中间操作修改流的方式，都可能会改变分解过程的性能。例如，一个SIZED流可以分成大小相等的两部分，这样每个部分都可以比较高效地并行处理，但筛选操作可能丢弃的元素个数却无法预测，导致流本身的大小未知。</p></li> <li><p>还要考虑终端操作中合并步骤的代价是大是小(例如Collector中的combiner方法)。</p></li></ol> <p>参考文档：<br>
《java8实战》<br> <a href="https://www.cnblogs.com/CarpenterLee/p/6637118.html">深入理解java stream流水线</a></p></div> <footer class="page-edit" style="display:none;"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">4/20/2020, 1:02:33 AM</span></div></footer> <!----> <!----></main> <!----> <div class="comments-wrapper" data-v-4698c43e><div class="valine-wrapper"><div id="valine"></div></div></div></div></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-a81d141e data-v-a81d141e><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-a81d141e><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-a81d141e></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-a81d141e></path></svg></div><div class="reco-bgm-panel" data-v-512e724b><audio id="bgm" src="http://music.163.com/song/media/outer/url?id=25707139.mp3" data-v-512e724b></audio> <div class="reco-float-box" style="bottom:100px;z-index:999999;display:none;" data-v-512e724b><img src="http://p0.meituan.net/scarlett/dc2299bb37cc4ecd472d8ae10e56f12e330651.jpg" data-v-512e724b></div> <div class="reco-bgm-box" style="left:10px;bottom:10px;z-index:999999;display:;" data-v-512e724b><div class="reco-bgm-cover" style="background-image:url(http://p0.meituan.net/scarlett/dc2299bb37cc4ecd472d8ae10e56f12e330651.jpg);" data-v-512e724b><div class="mini-operation" style="display:none;" data-v-512e724b><i class="reco-bgm reco-bgm-pause" style="display:none;" data-v-512e724b></i> <i class="reco-bgm reco-bgm-play" style="display:none;" data-v-512e724b></i></div> <div class="falut-message" style="display:none;" data-v-512e724b>
        播放失败
      </div></div> <div class="reco-bgm-info" style="display:;" data-v-512e724b><div class="info-box" data-v-512e724b><i class="reco-bgm reco-bgm-music music" data-v-512e724b></i>一生所爱</div> <div class="info-box" data-v-512e724b><i class="reco-bgm reco-bgm-artist" data-v-512e724b></i>卢冠廷</div> <div class="reco-bgm-progress" data-v-512e724b><div class="progress-bar" data-v-512e724b><div class="bar" data-v-512e724b></div></div></div> <div class="reco-bgm-operation" data-v-512e724b><i class="reco-bgm reco-bgm-last last" data-v-512e724b></i> <i class="reco-bgm reco-bgm-pause pause" style="display:none;" data-v-512e724b></i> <i class="reco-bgm reco-bgm-play play" style="display:;" data-v-512e724b></i> <i class="reco-bgm reco-bgm-next next" data-v-512e724b></i> <i class="reco-bgm reco-bgm-volume1 volume" style="display:;" data-v-512e724b></i> <i class="reco-bgm reco-bgm-mute mute" style="display:none;" data-v-512e724b></i> <div class="volume-bar" data-v-512e724b><div class="bar" data-v-512e724b></div></div></div></div> <div class="reco-bgm-left-box" style="display:;" data-v-512e724b><i class="reco-bgm reco-bgm-left" data-v-512e724b></i></div></div></div></div></div>
    <script src="/assets/js/app.bc3533d3.js" defer></script><script src="/assets/js/4.3246cf6a.js" defer></script><script src="/assets/js/1.4b387ef0.js" defer></script><script src="/assets/js/50.e66fa8af.js" defer></script>
  </body>
</html>
